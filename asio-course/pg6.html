<!DOCTYPE html>
<html>
<head>
<title>Error handling</title>
<link rel="stylesheet" type="text/css" href="basic.css">
</head>
<body>
<div class="nav">
<a href="pg5.html"><img src="prev.png" alt="Prev"></a><a href="pg1.html"><img src="up.png" alt="Up"></a><a href="pg1.html"><img src="home.png" alt="Home"></a><a href="pg7.html"><img src="next.png" alt="Next"></a>
</div>
<h1 class="ipsType_pagetitle">A guide to getting started with asio</h1>
<div class="desc">
Posted by <strong><a title="" href="http://www.gamedev.net/user/64367-drew_benton/" class=
"url fn name ___hover___member _hoversetup" id="anonymous_element_3" name=
"anonymous_element_3"><span>Drew_Benton</span></a></strong>, 31 January 2011 ~ 190,508 views
</div>
<br class="clear">
<div class="entry_content ipsType_textblock ipsPad">
<strong class="bbc">5. Error handling</strong>
<br>
<br>
The next concept we need to be aware of is error handling. In other words, what happens when our work function throws an exception?
Boost::asio gives users two ways to handle this case. The errors are propagated through the handlers to the point where a thread
calls a run or poll family of functions. The user can either handle the exception through a try/switch statement or they can opt to
receive the exception through an error variable. For more information regarding boost, take a look at <a rel="nofollow external"
title="External link" class="bbc_url" href="http://www.boost.org/community/error_handling.html">Error and Exception Handling</a>.
In addition, this <a rel="nofollow external" title="External link" class="bbc_url" href=
"http://en.highscore.de/cpp/boost/errorhandling.html">Error Handling</a> article covers some more useful points as well.
<br>
<br>
First, we will look at the exception method.
<br>
<br>
<strong class="bbc">Example 5a</strong>
<pre class="hl"><span class="hl lin">    1 </span><span class="hl ppc">#include &lt;asio.hpp&gt;</span>
<span class="hl lin">    2 </span><span class="hl ppc">#include &lt;memory&gt;</span>
<span class="hl lin">    3 </span><span class="hl ppc">#include &lt;thread&gt;</span>
<span class="hl lin">    4 </span><span class="hl ppc">#include &lt;mutex&gt;</span>
<span class="hl lin">    5 </span><span class="hl ppc">#include &lt;functional&gt;</span>
<span class="hl lin">    6 </span><span class="hl ppc">#include &lt;iostream&gt;</span>
<span class="hl lin">    7 </span>
<span class="hl lin">    8 </span>std<span class="hl opt">::</span>mutex global_stream_lock<span class="hl opt">;</span>
<span class="hl lin">    9 </span>
<span class="hl lin">   10 </span><span class="hl kwb">void</span> <span class="hl kwd">WorkerThread</span><span class="hl opt">(</span> std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span> asio<span class="hl opt">::</span>io_service <span class="hl opt">&gt;</span> io_service <span class="hl opt">)</span>
<span class="hl lin">   11 </span><span class="hl opt">{</span>
<span class="hl lin">   12 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   13 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">()</span>
<span class="hl lin">   14 </span>        <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;] Thread Start&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   15 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   16 </span>
<span class="hl lin">   17 </span>    <span class="hl kwa">try</span>
<span class="hl lin">   18 </span>    <span class="hl opt">{</span>
<span class="hl lin">   19 </span>        io_service<span class="hl opt">-&gt;</span><span class="hl kwd">run</span><span class="hl opt">();</span>
<span class="hl lin">   20 </span>    <span class="hl opt">}</span>
<span class="hl lin">   21 </span>    <span class="hl kwa">catch</span><span class="hl opt">(</span> std<span class="hl opt">::</span>exception <span class="hl opt">&amp;</span> ex <span class="hl opt">)</span>
<span class="hl lin">   22 </span>    <span class="hl opt">{</span>
<span class="hl lin">   23 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   24 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">()</span>
<span class="hl lin">   25 </span>            <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   26 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   27 </span>    <span class="hl opt">}</span>
<span class="hl lin">   28 </span>
<span class="hl lin">   29 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   30 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">()</span>
<span class="hl lin">   31 </span>        <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;] Thread Finish&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   32 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   33 </span><span class="hl opt">}</span>
<span class="hl lin">   34 </span>
<span class="hl lin">   35 </span><span class="hl kwb">void</span> <span class="hl kwd">RaiseAnException</span><span class="hl opt">(</span> std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span> asio<span class="hl opt">::</span>io_service <span class="hl opt">&gt;</span> io_service <span class="hl opt">)</span>
<span class="hl lin">   36 </span><span class="hl opt">{</span>
<span class="hl lin">   37 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   38 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">()</span>
<span class="hl lin">   39 </span>        <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;] &quot;</span> <span class="hl opt">&lt;&lt;</span> __FUNCTION__ <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   40 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   41 </span>
<span class="hl lin">   42 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">post</span><span class="hl opt">(</span> std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">( &amp;</span>RaiseAnException<span class="hl opt">,</span> io_service <span class="hl opt">) );</span>
<span class="hl lin">   43 </span>
<span class="hl lin">   44 </span>    <span class="hl kwa">throw</span><span class="hl opt">(</span> std<span class="hl opt">::</span><span class="hl kwd">runtime_error</span><span class="hl opt">(</span> <span class="hl str">&quot;Oops!&quot;</span> <span class="hl opt">) );</span>
<span class="hl lin">   45 </span><span class="hl opt">}</span>
<span class="hl lin">   46 </span>
<span class="hl lin">   47 </span><span class="hl kwb">int</span> <span class="hl kwd">main</span><span class="hl opt">(</span> <span class="hl kwb">int</span> argc<span class="hl opt">,</span> <span class="hl kwb">char</span> <span class="hl opt">*</span> argv<span class="hl opt">[] )</span>
<span class="hl lin">   48 </span><span class="hl opt">{</span>
<span class="hl lin">   49 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span> asio<span class="hl opt">::</span>io_service <span class="hl opt">&gt;</span> <span class="hl kwd">io_service</span><span class="hl opt">(</span>
<span class="hl lin">   50 </span>        <span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service
<span class="hl lin">   51 </span>        <span class="hl opt">);</span>
<span class="hl lin">   52 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>work <span class="hl opt">&gt;</span> <span class="hl kwd">work</span><span class="hl opt">(</span>
<span class="hl lin">   53 </span>        <span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">work</span><span class="hl opt">( *</span>io_service <span class="hl opt">)</span>
<span class="hl lin">   54 </span>        <span class="hl opt">);</span>
<span class="hl lin">   55 </span>
<span class="hl lin">   56 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   57 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">()</span>
<span class="hl lin">   58 </span>        <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;] The program will exit when all work has finished.&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   59 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   60 </span>
<span class="hl lin">   61 </span>    std<span class="hl opt">::</span>thread worker_threads<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">];</span>
<span class="hl lin">   62 </span>    <span class="hl kwa">for</span><span class="hl opt">(</span> <span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x <span class="hl opt">)</span>
<span class="hl lin">   63 </span>    <span class="hl opt">{</span>
<span class="hl lin">   64 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">] =</span> std<span class="hl opt">::</span><span class="hl kwd">thread</span><span class="hl opt">(</span> std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">( &amp;</span>WorkerThread<span class="hl opt">,</span> io_service <span class="hl opt">) );</span>
<span class="hl lin">   65 </span>    <span class="hl opt">}</span>
<span class="hl lin">   66 </span>
<span class="hl lin">   67 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">post</span><span class="hl opt">(</span> std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">( &amp;</span>RaiseAnException<span class="hl opt">,</span> io_service <span class="hl opt">) );</span>
<span class="hl lin">   68 </span>
<span class="hl lin">   69 </span>    <span class="hl kwa">for</span><span class="hl opt">(</span> <span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x <span class="hl opt">)</span>
<span class="hl lin">   70 </span>    <span class="hl opt">{</span>
<span class="hl lin">   71 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">();</span>
<span class="hl lin">   72 </span>    <span class="hl opt">}</span>
<span class="hl lin">   73 </span>
<span class="hl lin">   74 </span>    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl lin">   75 </span><span class="hl opt">}</span>
</pre>

<strong>Output</strong>
<pre class="hl"><span class="hl lin">    1 </span>[140065979995968] The program will exit when all work has finished.
<span class="hl lin">    2 </span>[140065963230976] Thread Start
<span class="hl lin">    3 </span>[140065954838272] Thread Start
<span class="hl lin">    4 </span>[140065963230976] RaiseAnException
<span class="hl lin">    5 </span>[140065954838272] RaiseAnException
<span class="hl lin">    6 </span>[140065963230976] Exception: Oops!
<span class="hl lin">    7 </span>[140065954838272] Exception: Oops!
<span class="hl lin">    8 </span>[140065954838272] Thread Finish
<span class="hl lin">    9 </span>[140065963230976] Thread Finish
</pre>

In this example, we post work to the io_service that causes exceptions over and over. The work object is not destroyed either so
the io_service should be kept busy. However, when we run the program, we see it exits. The reason is because the exception
propagated through the run function, so the worker threads exited. Since all worker threads exited, the program is done since
join_all returns. Immediately we can see how this could lead to problems if we are not careful since worker threads could be taken
out one by one until the system has none left.
<br>
<br>
Now let us take a look at the error variable approach that is also possible.
<br>
<br>
<strong class="bbc">Example 5b</strong>
<pre class="hl"><span class="hl lin">    1 </span><span class="hl ppc">#include &lt;asio.hpp&gt;</span>
<span class="hl lin">    2 </span><span class="hl ppc">#include &lt;memory&gt;</span>
<span class="hl lin">    3 </span><span class="hl ppc">#include &lt;thread&gt;</span>
<span class="hl lin">    4 </span><span class="hl ppc">#include &lt;mutex&gt;</span>
<span class="hl lin">    5 </span><span class="hl ppc">#include &lt;functional&gt;</span>
<span class="hl lin">    6 </span><span class="hl ppc">#include &lt;iostream&gt;</span>
<span class="hl lin">    7 </span>
<span class="hl lin">    8 </span>std<span class="hl opt">::</span>mutex global_stream_lock<span class="hl opt">;</span>
<span class="hl lin">    9 </span>
<span class="hl lin">   10 </span><span class="hl kwb">void</span> <span class="hl kwd">WorkerThread</span><span class="hl opt">(</span>std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> io_service<span class="hl opt">)</span>
<span class="hl lin">   11 </span><span class="hl opt">{</span>
<span class="hl lin">   12 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   13 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Start&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   14 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   15 </span>
<span class="hl lin">   16 </span>    asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">   17 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">run</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">   18 </span>
<span class="hl lin">   19 </span>    <span class="hl kwa">if</span> <span class="hl opt">(</span>ec<span class="hl opt">)</span>
<span class="hl lin">   20 </span>    <span class="hl opt">{</span>
<span class="hl lin">   21 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   22 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ec <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   23 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   24 </span>    <span class="hl opt">}</span>
<span class="hl lin">   25 </span>
<span class="hl lin">   26 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   27 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Finish&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   28 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   29 </span><span class="hl opt">}</span>
<span class="hl lin">   30 </span>
<span class="hl lin">   31 </span><span class="hl kwb">void</span> <span class="hl kwd">RaiseAnException</span><span class="hl opt">(</span>std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> io_service<span class="hl opt">)</span>
<span class="hl lin">   32 </span><span class="hl opt">{</span>
<span class="hl lin">   33 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   34 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] &quot;</span> <span class="hl opt">&lt;&lt;</span> __FUNCTION__ <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   35 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   36 </span>
<span class="hl lin">   37 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">post</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>RaiseAnException<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   38 </span>
<span class="hl lin">   39 </span>    <span class="hl kwa">throw</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">runtime_error</span><span class="hl opt">(</span><span class="hl str">&quot;Oops!&quot;</span><span class="hl opt">));</span>
<span class="hl lin">   40 </span><span class="hl opt">}</span>
<span class="hl lin">   41 </span>
<span class="hl lin">   42 </span><span class="hl kwb">int</span> <span class="hl kwd">main</span><span class="hl opt">(</span><span class="hl kwb">int</span> argc<span class="hl opt">,</span> <span class="hl kwb">char</span><span class="hl opt">*</span> argv<span class="hl opt">[])</span>
<span class="hl lin">   43 </span><span class="hl opt">{</span>
<span class="hl lin">   44 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> <span class="hl kwd">io_service</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   45 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>work<span class="hl opt">&gt;</span> <span class="hl kwd">work</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">work</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   46 </span>
<span class="hl lin">   47 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   48 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] The program will exit when all work has finished.&quot;</span>
<span class="hl lin">   49 </span>              <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   50 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   51 </span>
<span class="hl lin">   52 </span>    std<span class="hl opt">::</span>thread worker_threads<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">];</span>
<span class="hl lin">   53 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   54 </span>    <span class="hl opt">{</span>
<span class="hl lin">   55 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">] =</span> std<span class="hl opt">::</span><span class="hl kwd">thread</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>WorkerThread<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   56 </span>    <span class="hl opt">}</span>
<span class="hl lin">   57 </span>
<span class="hl lin">   58 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">post</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>RaiseAnException<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   59 </span>
<span class="hl lin">   60 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   61 </span>    <span class="hl opt">{</span>
<span class="hl lin">   62 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">();</span>
<span class="hl lin">   63 </span>    <span class="hl opt">}</span>
<span class="hl lin">   64 </span>
<span class="hl lin">   65 </span>    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl lin">   66 </span><span class="hl opt">}</span>
</pre>

<strong>Output</strong>
<pre class="hl"><span class="hl lin">    1 </span>[139793703814976] The program will exit when all work has finished.
<span class="hl lin">    2 </span>[139793687049984] Thread Start
<span class="hl lin">    3 </span>[139793687049984] RaiseAnException
<span class="hl lin">    4 </span>[139793678657280] Thread Start
<span class="hl lin">    5 </span>[139793678657280] RaiseAnException
<span class="hl lin">    6 </span>terminate called after throwing an instance of 'terminate called recursively
<span class="hl lin">    7 </span>std::runtime_error'
<span class="hl lin">    8 </span>Aborted (core dumped)
<span class="hl lin">    9 </span>
</pre>

Uh oh! When we run the program we get a crash. Through debugging, we can see that it is because the exception was not caught. This
is because the error variable approach does not convert <em class="bbc">user exceptions</em> to errors but rather <em class=
"bbc">asio exceptions</em>. This is very important to keep in mind! If we are passing our own work through an io_service, we
have to keep true to C++ exception programming concepts. If the asio library were to generate an error, it would either come
as an exception if no error variable was used or it would be converted to an error variable. Depending on our application, we would
choose the one that best fits what we need to do.
<br>
<br>
To further clarify once again if we are using the io_service for user work, we have to use exception handling if the work can
generate exceptions. If we are using the io_service for asio functions only, then we can use exception handling or the error
variable as either will do. If we are using the io_service for both asio functions and user work, then we can either use
both methods or just the exception handling method, but not only the error variable if the work can generate an exception. That
should be pretty straightforward to follow.
<br>
<br>
Now that we know of this little detail, we have to consider what should happen if an exception is actually generated. What we want
to do also depends on the type of application we are developing. In other words, are exceptions system failures or context
failures? If they are system failures, then we will want to call the stop member function of the io_service and make sure the work
object is destroyed so our program gracefully exits. If exceptions are simply context failures, then we will want to setup the
worker thread function to call the run function again so the worker thread does not die. Here is the previous example modified.
<br>
<br>
<strong class="bbc">Example 5c</strong>
<pre class="hl"><span class="hl lin">    1 </span><span class="hl ppc">#include &lt;asio.hpp&gt;</span>
<span class="hl lin">    2 </span><span class="hl ppc">#include &lt;memory&gt;</span>
<span class="hl lin">    3 </span><span class="hl ppc">#include &lt;thread&gt;</span>
<span class="hl lin">    4 </span><span class="hl ppc">#include &lt;mutex&gt;</span>
<span class="hl lin">    5 </span><span class="hl ppc">#include &lt;functional&gt;</span>
<span class="hl lin">    6 </span><span class="hl ppc">#include &lt;iostream&gt;</span>
<span class="hl lin">    7 </span>
<span class="hl lin">    8 </span>std<span class="hl opt">::</span>mutex global_stream_lock<span class="hl opt">;</span>
<span class="hl lin">    9 </span>
<span class="hl lin">   10 </span><span class="hl kwb">void</span> <span class="hl kwd">WorkerThread</span><span class="hl opt">(</span>std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> io_service<span class="hl opt">)</span>
<span class="hl lin">   11 </span><span class="hl opt">{</span>
<span class="hl lin">   12 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   13 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Start&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   14 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   15 </span>
<span class="hl lin">   16 </span>    <span class="hl kwb">int</span> i <span class="hl opt">=</span> <span class="hl num">10</span><span class="hl opt">;</span>
<span class="hl lin">   17 </span>    <span class="hl kwa">while</span> <span class="hl opt">(</span>i <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">)</span>
<span class="hl lin">   18 </span>    <span class="hl opt">{</span>
<span class="hl lin">   19 </span>        i<span class="hl opt">--;</span>
<span class="hl lin">   20 </span>        <span class="hl kwa">try</span>
<span class="hl lin">   21 </span>        <span class="hl opt">{</span>
<span class="hl lin">   22 </span>            asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">   23 </span>            io_service<span class="hl opt">-&gt;</span><span class="hl kwd">run</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">   24 </span>            <span class="hl kwa">if</span> <span class="hl opt">(</span>ec<span class="hl opt">)</span>
<span class="hl lin">   25 </span>            <span class="hl opt">{</span>
<span class="hl lin">   26 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   27 </span>                std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Error: &quot;</span> <span class="hl opt">&lt;&lt;</span> ec <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   28 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   29 </span>            <span class="hl opt">}</span>
<span class="hl lin">   30 </span>            <span class="hl kwa">break</span><span class="hl opt">;</span>
<span class="hl lin">   31 </span>        <span class="hl opt">}</span>
<span class="hl lin">   32 </span>        <span class="hl kwa">catch</span> <span class="hl opt">(</span>std<span class="hl opt">::</span>exception<span class="hl opt">&amp;</span> ex<span class="hl opt">)</span>
<span class="hl lin">   33 </span>        <span class="hl opt">{</span>
<span class="hl lin">   34 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   35 </span>            std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   36 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   37 </span>        <span class="hl opt">}</span>
<span class="hl lin">   38 </span>    <span class="hl opt">}</span>
<span class="hl lin">   39 </span>
<span class="hl lin">   40 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   41 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Finish&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   42 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   43 </span><span class="hl opt">}</span>
<span class="hl lin">   44 </span>
<span class="hl lin">   45 </span><span class="hl kwb">void</span> <span class="hl kwd">RaiseAnException</span><span class="hl opt">(</span>std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> io_service<span class="hl opt">)</span>
<span class="hl lin">   46 </span><span class="hl opt">{</span>
<span class="hl lin">   47 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   48 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] &quot;</span> <span class="hl opt">&lt;&lt;</span> __FUNCTION__ <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   49 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   50 </span>
<span class="hl lin">   51 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">post</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>RaiseAnException<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   52 </span>
<span class="hl lin">   53 </span>    <span class="hl kwa">throw</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">runtime_error</span><span class="hl opt">(</span><span class="hl str">&quot;Oops!&quot;</span><span class="hl opt">));</span>
<span class="hl lin">   54 </span><span class="hl opt">}</span>
<span class="hl lin">   55 </span>
<span class="hl lin">   56 </span><span class="hl kwb">int</span> <span class="hl kwd">main</span><span class="hl opt">(</span><span class="hl kwb">int</span> argc<span class="hl opt">,</span> <span class="hl kwb">char</span><span class="hl opt">*</span> argv<span class="hl opt">[])</span>
<span class="hl lin">   57 </span><span class="hl opt">{</span>
<span class="hl lin">   58 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> <span class="hl kwd">io_service</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   59 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>work<span class="hl opt">&gt;</span> <span class="hl kwd">work</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">work</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   60 </span>
<span class="hl lin">   61 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   62 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] The program will exit when all work has finished.&quot;</span>
<span class="hl lin">   63 </span>              <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   64 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   65 </span>
<span class="hl lin">   66 </span>    std<span class="hl opt">::</span>thread worker_threads<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">];</span>
<span class="hl lin">   67 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   68 </span>    <span class="hl opt">{</span>
<span class="hl lin">   69 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">] =</span> std<span class="hl opt">::</span><span class="hl kwd">thread</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>WorkerThread<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   70 </span>    <span class="hl opt">}</span>
<span class="hl lin">   71 </span>
<span class="hl lin">   72 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">post</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>RaiseAnException<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   73 </span>
<span class="hl lin">   74 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   75 </span>    <span class="hl opt">{</span>
<span class="hl lin">   76 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">();</span>
<span class="hl lin">   77 </span>    <span class="hl opt">}</span>
<span class="hl lin">   78 </span>
<span class="hl lin">   79 </span>    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl lin">   80 </span><span class="hl opt">}</span>
</pre>

<strong>Output</strong>
<pre class="hl"><span class="hl lin">    1 </span>[139900583372608] The program will exit when all work has finished.
<span class="hl lin">    2 </span>[139900566607616] Thread Start
<span class="hl lin">    3 </span>[139900558214912] Thread Start
<span class="hl lin">    4 </span>[139900566607616] RaiseAnException
<span class="hl lin">    5 </span>[139900558214912] RaiseAnException
<span class="hl lin">    6 </span>[139900566607616] Exception: Oops!
<span class="hl lin">    7 </span>[139900558214912] Exception: Oops!
<span class="hl lin">    8 </span>[139900566607616] RaiseAnException
<span class="hl lin">    9 </span>[139900558214912] RaiseAnException
<span class="hl lin">      </span>...
<span class="hl lin">      </span>...
<span class="hl lin">   92 </span>[139900566607616] RaiseAnException
<span class="hl lin">   93 </span>[139900558214912] Exception: Oops!
<span class="hl lin">   94 </span>[139900558214912] RaiseAnException
<span class="hl lin">   95 </span>[139900566607616] Exception: Oops!
<span class="hl lin">   96 </span>[139900566607616] Thread Finish
<span class="hl lin">   97 </span>[139900558214912] Exception: Oops!
<span class="hl lin">      </span>...
<span class="hl lin">      </span>...
</pre>

Now, when an exception occurs, it is outputted and the worker thread goes back to handling work. When the stop member function is
called or the work object is destroyed, the run function no longer blocks as we have seen before, so the loop exits and then the
thread finishes up. If we were to use this concept on the exception example, we would see an infinite output of the events since we
are always posting new events to the queue. Obviously we would never want to have such a situation occur in a real program.
<br>
<br>
Most of the errors we will run into from the asio library will come from the actual I/O interfaces such as sockets. We are
not quite ready to dive into those yet. There are still more useful features of the asio library we need to get exposed to
first.
<br>
<hr>
<div class="nav">
<a accesskey="p" href="pg5.html"><img src="prev.png" alt="Prev"></a><a accesskey="u" href="pg1.html"><img src="up.png" alt="Up"></a><a accesskey="h" href="pg1.html"><img src="home.png" alt="Home"></a><a accesskey="n" href="pg7.html"><img src="next.png" alt="Next"></a>
</div>
</div>
</body>
</html>
