<!DOCTYPE html>
<html>
<head>
<title>Networking basics: connectors and acceptors (TCP)</title>
<link rel="stylesheet" type="text/css" href="basic.css">
</head>
<body>
<div class="nav">
<a href="pg7.html"><img src="prev.png" alt="Prev"></a><a href="pg1.html"><img src="up.png" alt="Up"></a><a href="pg1.html"><img src="home.png" alt="Home"></a><a href="pg9.html"><img src="next.png" alt="Next"></a>
</div>
<h1 class="ipsType_pagetitle">A guide to getting started with asio</h1>
<div class="desc">
Posted by <strong><a title="" href="http://www.gamedev.net/user/64367-drew_benton/" class=
"url fn name ___hover___member _hoversetup" id="anonymous_element_3" name=
"anonymous_element_3"><span>Drew_Benton</span></a></strong>, 31 January 2011 ~ 190,508 views
</div>
<br class="clear">
<div class="entry_content ipsType_textblock ipsPad">
<strong class="bbc">7. Networking basics: connectors and acceptors (TCP)</strong> The first concepts of the asio networking
system we will cover will be TCP programming. The nice thing about the asio library is consistency. Having covered the other
aspects of the asio library, we already know and understand the framework the network system uses. We just have to learn the
specific networking API functions!
<br>
<br>
To get started, we will see how to connect synchronously to a host. Since our program will be acting as a client, we will be using
the <a rel="nofollow external" title="External link" class="bbc_url" href=
"http://think-async.com/Asio/asio-1.11.0/doc/asio/reference/ip__tcp/socket.html">tcp::socket</a> object now. There are
different socket types for the different protocols available. As a result, we must make sure we use the correct objects and
functions from the correct namespace. Before we can connect to a remote host, we must be able to get the address of the remote
host. To do this, we will make use of <a rel="nofollow external" title="External link" class="bbc_url" href=
"http://think-async.com/Asio/asio-1.11.0/doc/asio/reference/ip__tcp/resolver.html">tcp::resolver</a>.
<br>
<br>
<strong class="bbc">Example 7a</strong>
<pre class="hl"><span class="hl lin">    1 </span><span class="hl ppc">#include &lt;asio.hpp&gt;</span>
<span class="hl lin">    2 </span><span class="hl ppc">#include &lt;memory&gt;</span>
<span class="hl lin">    3 </span><span class="hl ppc">#include &lt;thread&gt;</span>
<span class="hl lin">    4 </span><span class="hl ppc">#include &lt;mutex&gt;</span>
<span class="hl lin">    5 </span><span class="hl ppc">#include &lt;functional&gt;</span>
<span class="hl lin">    6 </span><span class="hl ppc">#include &lt;iostream&gt;</span>
<span class="hl lin">    7 </span><span class="hl ppc">#include &lt;string&gt;</span>
<span class="hl lin">    8 </span>
<span class="hl lin">    9 </span>std<span class="hl opt">::</span>mutex global_stream_lock<span class="hl opt">;</span>
<span class="hl lin">   10 </span>
<span class="hl lin">   11 </span><span class="hl kwb">void</span> <span class="hl kwd">WorkerThread</span><span class="hl opt">(</span>std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> io_service<span class="hl opt">)</span>
<span class="hl lin">   12 </span><span class="hl opt">{</span>
<span class="hl lin">   13 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   14 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Start&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   15 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   16 </span>
<span class="hl lin">   17 </span>    <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">true</span><span class="hl opt">)</span>
<span class="hl lin">   18 </span>    <span class="hl opt">{</span>
<span class="hl lin">   19 </span>        <span class="hl kwa">try</span>
<span class="hl lin">   20 </span>        <span class="hl opt">{</span>
<span class="hl lin">   21 </span>            asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">   22 </span>            io_service<span class="hl opt">-&gt;</span><span class="hl kwd">run</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">   23 </span>            <span class="hl kwa">if</span> <span class="hl opt">(</span>ec<span class="hl opt">)</span>
<span class="hl lin">   24 </span>            <span class="hl opt">{</span>
<span class="hl lin">   25 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   26 </span>                std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Error: &quot;</span> <span class="hl opt">&lt;&lt;</span> ec <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   27 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   28 </span>            <span class="hl opt">}</span>
<span class="hl lin">   29 </span>            <span class="hl kwa">break</span><span class="hl opt">;</span>
<span class="hl lin">   30 </span>        <span class="hl opt">}</span>
<span class="hl lin">   31 </span>        <span class="hl kwa">catch</span> <span class="hl opt">(</span>std<span class="hl opt">::</span>exception<span class="hl opt">&amp;</span> ex<span class="hl opt">)</span>
<span class="hl lin">   32 </span>        <span class="hl opt">{</span>
<span class="hl lin">   33 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   34 </span>            std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   35 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   36 </span>        <span class="hl opt">}</span>
<span class="hl lin">   37 </span>    <span class="hl opt">}</span>
<span class="hl lin">   38 </span>
<span class="hl lin">   39 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   40 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Finish&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   41 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   42 </span><span class="hl opt">}</span>
<span class="hl lin">   43 </span>
<span class="hl lin">   44 </span><span class="hl kwb">int</span> <span class="hl kwd">main</span><span class="hl opt">(</span><span class="hl kwb">int</span> argc<span class="hl opt">,</span> <span class="hl kwb">char</span><span class="hl opt">*</span> argv<span class="hl opt">[])</span>
<span class="hl lin">   45 </span><span class="hl opt">{</span>
<span class="hl lin">   46 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> <span class="hl kwd">io_service</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   47 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>work<span class="hl opt">&gt;</span> <span class="hl kwd">work</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">work</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   48 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>strand<span class="hl opt">&gt;</span> <span class="hl kwd">strand</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">strand</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   49 </span>
<span class="hl lin">   50 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   51 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Press [return] to exit.&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   52 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   53 </span>
<span class="hl lin">   54 </span>    std<span class="hl opt">::</span>thread worker_threads<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">];</span>
<span class="hl lin">   55 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   56 </span>    <span class="hl opt">{</span>
<span class="hl lin">   57 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">] =</span> std<span class="hl opt">::</span><span class="hl kwd">thread</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>WorkerThread<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   58 </span>    <span class="hl opt">}</span>
<span class="hl lin">   59 </span>
<span class="hl lin">   60 </span>    asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket <span class="hl kwd">sock</span><span class="hl opt">(*</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   61 </span>
<span class="hl lin">   62 </span>    <span class="hl kwa">try</span>
<span class="hl lin">   63 </span>    <span class="hl opt">{</span>
<span class="hl lin">   64 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver <span class="hl kwd">resolver</span><span class="hl opt">(*</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   65 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver<span class="hl opt">::</span>query <span class="hl kwd">query</span><span class="hl opt">(</span><span class="hl str">&quot;www.google.com&quot;</span><span class="hl opt">,</span> std<span class="hl opt">::</span><span class="hl kwd">to_string</span><span class="hl opt">(</span><span class="hl num">80</span><span class="hl opt">));</span>
<span class="hl lin">   66 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver<span class="hl opt">::</span>iterator iterator <span class="hl opt">=</span> resolver<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span>query<span class="hl opt">);</span>
<span class="hl lin">   67 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>endpoint endpoint <span class="hl opt">= *</span>iterator<span class="hl opt">;</span>
<span class="hl lin">   68 </span>
<span class="hl lin">   69 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   70 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;Connecting to: &quot;</span> <span class="hl opt">&lt;&lt;</span> endpoint <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   71 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   72 </span>
<span class="hl lin">   73 </span>        sock<span class="hl opt">.</span><span class="hl kwd">connect</span><span class="hl opt">(</span>endpoint<span class="hl opt">);</span>
<span class="hl lin">   74 </span>    <span class="hl opt">}</span>
<span class="hl lin">   75 </span>    <span class="hl kwa">catch</span> <span class="hl opt">(</span>std<span class="hl opt">::</span>exception<span class="hl opt">&amp;</span> ex<span class="hl opt">)</span>
<span class="hl lin">   76 </span>    <span class="hl opt">{</span>
<span class="hl lin">   77 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   78 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   79 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   80 </span>    <span class="hl opt">}</span>
<span class="hl lin">   81 </span>
<span class="hl lin">   82 </span>    std<span class="hl opt">::</span>cin<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">();</span>
<span class="hl lin">   83 </span>
<span class="hl lin">   84 </span>    asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">   85 </span>    sock<span class="hl opt">.</span><span class="hl kwd">shutdown</span><span class="hl opt">(</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket<span class="hl opt">::</span>shutdown_both<span class="hl opt">,</span> ec<span class="hl opt">);</span>
<span class="hl lin">   86 </span>    sock<span class="hl opt">.</span><span class="hl kwd">close</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">   87 </span>
<span class="hl lin">   88 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">stop</span><span class="hl opt">();</span>
<span class="hl lin">   89 </span>
<span class="hl lin">   90 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   91 </span>    <span class="hl opt">{</span>
<span class="hl lin">   92 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">();</span>
<span class="hl lin">   93 </span>    <span class="hl opt">}</span>
<span class="hl lin">   94 </span>
<span class="hl lin">   95 </span>    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl lin">   96 </span><span class="hl opt">}</span>
</pre>

<strong>Output</strong>
<pre class="hl"><span class="hl lin">    1 </span>[139780310337344] Press [return] to exit.
<span class="hl lin">    2 </span>[139780293572352] Thread Start
<span class="hl lin">    3 </span>[139780285179648] Thread Start
<span class="hl lin">    4 </span>Connecting to: 216.58.223.4:80
<span class="hl lin">    5 </span>
<span class="hl lin">    6 </span>[139780293572352] Thread Finish
<span class="hl lin">    7 </span>[139780285179648] Thread Finish
</pre>

This example will simply open a connection to Google. The program will tell us the actual IP and port it is attempting to connect
to. If we open a command prompt and run the command "netstat -n", we should see a TCP connection of the program. In this example,
we use the format for the query object to have reusable code. It might be common for the port to be an integer rather than a
string, so we make use of <a rel="nofollow external" title="External link" class="bbc_url" href=
"http://www.boost.org/doc/libs/1_60_0/libs/conversion/lexical_cast.htm">lexical_cast</a> to convert it to a string. While there are
other methods to do this, boost makes it quick and easy. For another example, make sure to take a look at the <a rel=
"nofollow external" title="External link" class="bbc_url" href=
"http://think-async.com/Asio/asio-1.11.0/doc/asio/tutorial/tutdaytime1.html">Daytime.1 - A synchronous TCP daytime
client</a> tutorial on the boost site as well.
<br>
<br>
Sometimes we might not want to connect synchronously to a remote host. Imagine a GUI application where we want to start a
connection via a button, but we do not want the GUI to freeze while the operation completes. Boost::asio provides a way to connect
asynchronously through the socket as well. Using the techniques we have already learned, such as using std::bind and
std::shared_ptr, we can setup our own connect handler that will be invoked.
<br>
<br>
<strong class="bbc">Example 7b</strong>
<pre class="hl"><span class="hl lin">    1 </span><span class="hl ppc">#include &lt;asio.hpp&gt;</span>
<span class="hl lin">    2 </span><span class="hl ppc">#include &lt;memory&gt;</span>
<span class="hl lin">    3 </span><span class="hl ppc">#include &lt;thread&gt;</span>
<span class="hl lin">    4 </span><span class="hl ppc">#include &lt;mutex&gt;</span>
<span class="hl lin">    5 </span><span class="hl ppc">#include &lt;functional&gt;</span>
<span class="hl lin">    6 </span><span class="hl ppc">#include &lt;iostream&gt;</span>
<span class="hl lin">    7 </span><span class="hl ppc">#include &lt;string&gt;</span>
<span class="hl lin">    8 </span>
<span class="hl lin">    9 </span><span class="hl kwa">using namespace</span> std<span class="hl opt">::</span>placeholders<span class="hl opt">;</span> <span class="hl slc">// adds _1, _2, ...</span>
<span class="hl lin">   10 </span>std<span class="hl opt">::</span>mutex global_stream_lock<span class="hl opt">;</span>
<span class="hl lin">   11 </span>
<span class="hl lin">   12 </span><span class="hl kwb">void</span> <span class="hl kwd">WorkerThread</span><span class="hl opt">(</span>std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> io_service<span class="hl opt">)</span>
<span class="hl lin">   13 </span><span class="hl opt">{</span>
<span class="hl lin">   14 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   15 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Start&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   16 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   17 </span>
<span class="hl lin">   18 </span>    <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">true</span><span class="hl opt">)</span>
<span class="hl lin">   19 </span>    <span class="hl opt">{</span>
<span class="hl lin">   20 </span>        <span class="hl kwa">try</span>
<span class="hl lin">   21 </span>        <span class="hl opt">{</span>
<span class="hl lin">   22 </span>            asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">   23 </span>            io_service<span class="hl opt">-&gt;</span><span class="hl kwd">run</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">   24 </span>            <span class="hl kwa">if</span> <span class="hl opt">(</span>ec<span class="hl opt">)</span>
<span class="hl lin">   25 </span>            <span class="hl opt">{</span>
<span class="hl lin">   26 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   27 </span>                std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Error: &quot;</span> <span class="hl opt">&lt;&lt;</span> ec <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   28 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   29 </span>            <span class="hl opt">}</span>
<span class="hl lin">   30 </span>            <span class="hl kwa">break</span><span class="hl opt">;</span>
<span class="hl lin">   31 </span>        <span class="hl opt">}</span>
<span class="hl lin">   32 </span>        <span class="hl kwa">catch</span> <span class="hl opt">(</span>std<span class="hl opt">::</span>exception<span class="hl opt">&amp;</span> ex<span class="hl opt">)</span>
<span class="hl lin">   33 </span>        <span class="hl opt">{</span>
<span class="hl lin">   34 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   35 </span>            std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   36 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   37 </span>        <span class="hl opt">}</span>
<span class="hl lin">   38 </span>    <span class="hl opt">}</span>
<span class="hl lin">   39 </span>
<span class="hl lin">   40 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   41 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Finish&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   42 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   43 </span><span class="hl opt">}</span>
<span class="hl lin">   44 </span>
<span class="hl lin">   45 </span><span class="hl kwb">void</span> <span class="hl kwd">OnConnect</span><span class="hl opt">(</span><span class="hl kwb">const</span> asio<span class="hl opt">::</span>error_code<span class="hl opt">&amp;</span> ec<span class="hl opt">,</span> std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket<span class="hl opt">&gt;</span> sock<span class="hl opt">)</span>
<span class="hl lin">   46 </span><span class="hl opt">{</span>
<span class="hl lin">   47 </span>    <span class="hl kwa">if</span> <span class="hl opt">(</span>ec<span class="hl opt">)</span>
<span class="hl lin">   48 </span>    <span class="hl opt">{</span>
<span class="hl lin">   49 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   50 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Error: &quot;</span> <span class="hl opt">&lt;&lt;</span> ec <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   51 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   52 </span>    <span class="hl opt">}</span>
<span class="hl lin">   53 </span>    <span class="hl kwa">else</span>
<span class="hl lin">   54 </span>    <span class="hl opt">{</span>
<span class="hl lin">   55 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   56 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Connected!&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   57 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   58 </span>    <span class="hl opt">}</span>
<span class="hl lin">   59 </span><span class="hl opt">}</span>
<span class="hl lin">   60 </span>
<span class="hl lin">   61 </span><span class="hl kwb">int</span> <span class="hl kwd">main</span><span class="hl opt">(</span><span class="hl kwb">int</span> argc<span class="hl opt">,</span> <span class="hl kwb">char</span><span class="hl opt">*</span> argv<span class="hl opt">[])</span>
<span class="hl lin">   62 </span><span class="hl opt">{</span>
<span class="hl lin">   63 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> <span class="hl kwd">io_service</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   64 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>work<span class="hl opt">&gt;</span> <span class="hl kwd">work</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">work</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   65 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>strand<span class="hl opt">&gt;</span> <span class="hl kwd">strand</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">strand</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   66 </span>
<span class="hl lin">   67 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   68 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Press [return] to exit.&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   69 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   70 </span>
<span class="hl lin">   71 </span>    std<span class="hl opt">::</span>thread worker_threads<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">];</span>
<span class="hl lin">   72 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   73 </span>    <span class="hl opt">{</span>
<span class="hl lin">   74 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">] =</span> std<span class="hl opt">::</span><span class="hl kwd">thread</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>WorkerThread<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   75 </span>    <span class="hl opt">}</span>
<span class="hl lin">   76 </span>
<span class="hl lin">   77 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket<span class="hl opt">&gt;</span> <span class="hl kwd">sock</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span><span class="hl kwd">socket</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   78 </span>
<span class="hl lin">   79 </span>    <span class="hl kwa">try</span>
<span class="hl lin">   80 </span>    <span class="hl opt">{</span>
<span class="hl lin">   81 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver <span class="hl kwd">resolver</span><span class="hl opt">(*</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   82 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver<span class="hl opt">::</span>query <span class="hl kwd">query</span><span class="hl opt">(</span><span class="hl str">&quot;www.google.com&quot;</span><span class="hl opt">,</span> std<span class="hl opt">::</span><span class="hl kwd">to_string</span><span class="hl opt">(</span><span class="hl num">80</span><span class="hl opt">));</span>
<span class="hl lin">   83 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver<span class="hl opt">::</span>iterator iterator <span class="hl opt">=</span> resolver<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span>query<span class="hl opt">);</span>
<span class="hl lin">   84 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>endpoint endpoint <span class="hl opt">= *</span>iterator<span class="hl opt">;</span>
<span class="hl lin">   85 </span>
<span class="hl lin">   86 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   87 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;Connecting to: &quot;</span> <span class="hl opt">&lt;&lt;</span> endpoint <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   88 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   89 </span>
<span class="hl lin">   90 </span>        sock<span class="hl opt">-&gt;</span><span class="hl kwd">async_connect</span><span class="hl opt">(</span>endpoint<span class="hl opt">,</span> std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(</span>OnConnect<span class="hl opt">,</span> _1<span class="hl opt">,</span> sock<span class="hl opt">));</span>
<span class="hl lin">   91 </span>    <span class="hl opt">}</span>
<span class="hl lin">   92 </span>    <span class="hl kwa">catch</span> <span class="hl opt">(</span>std<span class="hl opt">::</span>exception<span class="hl opt">&amp;</span> ex<span class="hl opt">)</span>
<span class="hl lin">   93 </span>    <span class="hl opt">{</span>
<span class="hl lin">   94 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   95 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   96 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   97 </span>    <span class="hl opt">}</span>
<span class="hl lin">   98 </span>
<span class="hl lin">   99 </span>    std<span class="hl opt">::</span>cin<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">();</span>
<span class="hl lin">  100 </span>
<span class="hl lin">  101 </span>    asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">  102 </span>    sock<span class="hl opt">-&gt;</span><span class="hl kwd">shutdown</span><span class="hl opt">(</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket<span class="hl opt">::</span>shutdown_both<span class="hl opt">,</span> ec<span class="hl opt">);</span>
<span class="hl lin">  103 </span>    sock<span class="hl opt">-&gt;</span><span class="hl kwd">close</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">  104 </span>
<span class="hl lin">  105 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">stop</span><span class="hl opt">();</span>
<span class="hl lin">  106 </span>
<span class="hl lin">  107 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">  108 </span>    <span class="hl opt">{</span>
<span class="hl lin">  109 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">();</span>
<span class="hl lin">  110 </span>    <span class="hl opt">}</span>
<span class="hl lin">  111 </span>
<span class="hl lin">  112 </span>    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl lin">  113 </span><span class="hl opt">}</span>
</pre>


<strong>Output</strong>
<pre class="hl"><span class="hl lin">    1 </span>[139662528407360] Press [return] to exit.
<span class="hl lin">    2 </span>[139662511642368] Thread Start
<span class="hl lin">    3 </span>[139662503249664] Thread Start
<span class="hl lin">    4 </span>Connecting to: 216.58.223.4:80
<span class="hl lin">    5 </span>[139662511642368] Connected!
<span class="hl lin">    6 </span>
<span class="hl lin">    7 </span>[139662511642368] Thread Finish
<span class="hl lin">    8 </span>[139662503249664] Thread Finish
</pre>
Just to make sure we are still on the same page, figuratively speaking, we have to use a std::shared_ptr with most asio
objects if we wish to pass them around. This is because the objects themselves are non-copyable and we have to ensure the object
remains valid while the handler is waiting to be called. We use std::bind to setup our own custom handler as well. This handler
can have any number of parameters in addition to the default number it has to have. In this case, the async_connect handler is a
ConnectHandler, which is simply a template parameter, but referring to the documentation we will see the signature it must have at
minimal.
<br>
<p class="citation">Quote</p>
<blockquote class="ipsBlockquote built">
<p>* @param handler The handler to be called when the connection operation
<br>
* completes. Copies will be made of the handler as required. The function
<br>
* signature of the handler must be:
<br>
* @code void handler(
<br>
* const std::system::error_code&amp; error // Result of operation
<br>
* ); @endcode
<br>
* Regardless of whether the asynchronous operation completes immediately or
<br>
* not, the handler will not be invoked from within this function. Invocation
<br>
* of the handler will be performed in a manner equivalent to using
<br>
* asio::io_service::post().
<br></p>
</blockquote>
<br>
One cool thing to note is that with std::bind, we can rearrange the order of parameters as we desire! All that matters is that
the parameter is physically there in the end. Hopefully now, the example makes sense as to why we do certain things. In this
example as the last, we still resolve the remote address synchronously. We can change this to an asynchronous method by referring
to the documentation if we wish. I prefer to keep it simple and just do the look-ups synchronously.
<br>
<br>
Now we have two different methods we can use to connect to remote hosts. What about letting remote hosts connect to us? To setup
such a "server", we will make use of the <a rel="nofollow external" title="External link" class="bbc_url" href=
"http://think-async.com/Asio/asio-1.11.0/doc/asio/reference/ip__tcp/acceptor.html">tcp::acceptor</a> object. While we
covered both synchronous and asynchronous methods for connecting, we will just briefly cover the asynchronous method for the
server. The reason is, the main goal to using the asio library is asynchronicity, even though it does provide synchronous
methods. We will see examples of more variations later but for now we will cover what will be used the most. Let us take a look at
the start of the server.
<br>
<br>
<strong class="bbc">Example 7c</strong>
<pre class="hl"><span class="hl lin">    1 </span><span class="hl ppc">#include &lt;asio.hpp&gt;</span>
<span class="hl lin">    2 </span><span class="hl ppc">#include &lt;memory&gt;</span>
<span class="hl lin">    3 </span><span class="hl ppc">#include &lt;thread&gt;</span>
<span class="hl lin">    4 </span><span class="hl ppc">#include &lt;mutex&gt;</span>
<span class="hl lin">    5 </span><span class="hl ppc">#include &lt;functional&gt;</span>
<span class="hl lin">    6 </span><span class="hl ppc">#include &lt;iostream&gt;</span>
<span class="hl lin">    7 </span><span class="hl ppc">#include &lt;string&gt;</span>
<span class="hl lin">    8 </span>
<span class="hl lin">    9 </span><span class="hl kwa">using namespace</span> std<span class="hl opt">::</span>placeholders<span class="hl opt">;</span> <span class="hl slc">// adds _1, _2, ...</span>
<span class="hl lin">   10 </span>std<span class="hl opt">::</span>mutex global_stream_lock<span class="hl opt">;</span>
<span class="hl lin">   11 </span>
<span class="hl lin">   12 </span><span class="hl kwb">void</span> <span class="hl kwd">WorkerThread</span><span class="hl opt">(</span>std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> io_service<span class="hl opt">)</span>
<span class="hl lin">   13 </span><span class="hl opt">{</span>
<span class="hl lin">   14 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   15 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Start&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   16 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   17 </span>
<span class="hl lin">   18 </span>    <span class="hl kwa">while</span> <span class="hl opt">(</span><span class="hl kwa">true</span><span class="hl opt">)</span>
<span class="hl lin">   19 </span>    <span class="hl opt">{</span>
<span class="hl lin">   20 </span>        <span class="hl kwa">try</span>
<span class="hl lin">   21 </span>        <span class="hl opt">{</span>
<span class="hl lin">   22 </span>            asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">   23 </span>            io_service<span class="hl opt">-&gt;</span><span class="hl kwd">run</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">   24 </span>            <span class="hl kwa">if</span> <span class="hl opt">(</span>ec<span class="hl opt">)</span>
<span class="hl lin">   25 </span>            <span class="hl opt">{</span>
<span class="hl lin">   26 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   27 </span>                std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Error: &quot;</span> <span class="hl opt">&lt;&lt;</span> ec <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   28 </span>                global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   29 </span>            <span class="hl opt">}</span>
<span class="hl lin">   30 </span>            <span class="hl kwa">break</span><span class="hl opt">;</span>
<span class="hl lin">   31 </span>        <span class="hl opt">}</span>
<span class="hl lin">   32 </span>        <span class="hl kwa">catch</span> <span class="hl opt">(</span>std<span class="hl opt">::</span>exception<span class="hl opt">&amp;</span> ex<span class="hl opt">)</span>
<span class="hl lin">   33 </span>        <span class="hl opt">{</span>
<span class="hl lin">   34 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   35 </span>            std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   36 </span>            global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   37 </span>        <span class="hl opt">}</span>
<span class="hl lin">   38 </span>    <span class="hl opt">}</span>
<span class="hl lin">   39 </span>
<span class="hl lin">   40 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   41 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Thread Finish&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   42 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   43 </span><span class="hl opt">}</span>
<span class="hl lin">   44 </span>
<span class="hl lin">   45 </span><span class="hl kwb">void</span> <span class="hl kwd">OnAccept</span><span class="hl opt">(</span><span class="hl kwb">const</span> asio<span class="hl opt">::</span>error_code<span class="hl opt">&amp;</span> ec<span class="hl opt">,</span> std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket<span class="hl opt">&gt;</span> sock<span class="hl opt">)</span>
<span class="hl lin">   46 </span><span class="hl opt">{</span>
<span class="hl lin">   47 </span>    <span class="hl kwa">if</span> <span class="hl opt">(</span>ec<span class="hl opt">)</span>
<span class="hl lin">   48 </span>    <span class="hl opt">{</span>
<span class="hl lin">   49 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   50 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Error: &quot;</span> <span class="hl opt">&lt;&lt;</span> ec <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   51 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   52 </span>    <span class="hl opt">}</span>
<span class="hl lin">   53 </span>    <span class="hl kwa">else</span>
<span class="hl lin">   54 </span>    <span class="hl opt">{</span>
<span class="hl lin">   55 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   56 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Accepted!&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   57 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   58 </span>    <span class="hl opt">}</span>
<span class="hl lin">   59 </span><span class="hl opt">}</span>
<span class="hl lin">   60 </span>
<span class="hl lin">   61 </span><span class="hl kwb">int</span> <span class="hl kwd">main</span><span class="hl opt">(</span><span class="hl kwb">int</span> argc<span class="hl opt">,</span> <span class="hl kwb">char</span><span class="hl opt">*</span> argv<span class="hl opt">[])</span>
<span class="hl lin">   62 </span><span class="hl opt">{</span>
<span class="hl lin">   63 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">&gt;</span> <span class="hl kwd">io_service</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   64 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>work<span class="hl opt">&gt;</span> <span class="hl kwd">work</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">work</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   65 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span>strand<span class="hl opt">&gt;</span> <span class="hl kwd">strand</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>io_service<span class="hl opt">::</span><span class="hl kwd">strand</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   66 </span>
<span class="hl lin">   67 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   68 </span>    std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Press [return] to exit.&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   69 </span>    global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   70 </span>
<span class="hl lin">   71 </span>    std<span class="hl opt">::</span>thread worker_threads<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">];</span>
<span class="hl lin">   72 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">   73 </span>    <span class="hl opt">{</span>
<span class="hl lin">   74 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">] =</span> std<span class="hl opt">::</span><span class="hl kwd">thread</span><span class="hl opt">(</span>std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(&amp;</span>WorkerThread<span class="hl opt">,</span> io_service<span class="hl opt">));</span>
<span class="hl lin">   75 </span>    <span class="hl opt">}</span>
<span class="hl lin">   76 </span>
<span class="hl lin">   77 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>acceptor<span class="hl opt">&gt;</span> <span class="hl kwd">acceptor</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span><span class="hl kwd">acceptor</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   78 </span>    std<span class="hl opt">::</span>shared_ptr<span class="hl opt">&lt;</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket<span class="hl opt">&gt;</span> <span class="hl kwd">sock</span><span class="hl opt">(</span><span class="hl kwa">new</span> asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span><span class="hl kwd">socket</span><span class="hl opt">(*</span>io_service<span class="hl opt">));</span>
<span class="hl lin">   79 </span>
<span class="hl lin">   80 </span>    <span class="hl kwa">try</span>
<span class="hl lin">   81 </span>    <span class="hl opt">{</span>
<span class="hl lin">   82 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver <span class="hl kwd">resolver</span><span class="hl opt">(*</span>io_service<span class="hl opt">);</span>
<span class="hl lin">   83 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>resolver<span class="hl opt">::</span>query <span class="hl kwd">query</span><span class="hl opt">(</span><span class="hl str">&quot;127.0.0.1&quot;</span><span class="hl opt">,</span> std<span class="hl opt">::</span><span class="hl kwd">to_string</span><span class="hl opt">(</span><span class="hl num">7777</span><span class="hl opt">));</span>
<span class="hl lin">   84 </span>        asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>endpoint endpoint <span class="hl opt">= *</span>resolver<span class="hl opt">.</span><span class="hl kwd">resolve</span><span class="hl opt">(</span>query<span class="hl opt">);</span>
<span class="hl lin">   85 </span>        acceptor<span class="hl opt">-&gt;</span><span class="hl kwd">open</span><span class="hl opt">(</span>endpoint<span class="hl opt">.</span><span class="hl kwd">protocol</span><span class="hl opt">());</span>
<span class="hl lin">   86 </span>        acceptor<span class="hl opt">-&gt;</span><span class="hl kwd">set_option</span><span class="hl opt">(</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>acceptor<span class="hl opt">::</span><span class="hl kwd">reuse_address</span><span class="hl opt">(</span><span class="hl kwa">false</span><span class="hl opt">));</span>
<span class="hl lin">   87 </span>        acceptor<span class="hl opt">-&gt;</span><span class="hl kwd">bind</span><span class="hl opt">(</span>endpoint<span class="hl opt">);</span>
<span class="hl lin">   88 </span>        acceptor<span class="hl opt">-&gt;</span><span class="hl kwd">listen</span><span class="hl opt">(</span>asio<span class="hl opt">::</span>socket_base<span class="hl opt">::</span>max_connections<span class="hl opt">);</span>
<span class="hl lin">   89 </span>        acceptor<span class="hl opt">-&gt;</span><span class="hl kwd">async_accept</span><span class="hl opt">(*</span>sock<span class="hl opt">,</span> std<span class="hl opt">::</span><span class="hl kwd">bind</span><span class="hl opt">(</span>OnAccept<span class="hl opt">,</span> _1<span class="hl opt">,</span> sock<span class="hl opt">));</span>
<span class="hl lin">   90 </span>
<span class="hl lin">   91 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   92 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;Listening on: &quot;</span> <span class="hl opt">&lt;&lt;</span> endpoint <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   93 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">   94 </span>    <span class="hl opt">}</span>
<span class="hl lin">   95 </span>    <span class="hl kwa">catch</span> <span class="hl opt">(</span>std<span class="hl opt">::</span>exception<span class="hl opt">&amp;</span> ex<span class="hl opt">)</span>
<span class="hl lin">   96 </span>    <span class="hl opt">{</span>
<span class="hl lin">   97 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">lock</span><span class="hl opt">();</span>
<span class="hl lin">   98 </span>        std<span class="hl opt">::</span>cout <span class="hl opt">&lt;&lt;</span> <span class="hl str">&quot;[&quot;</span> <span class="hl opt">&lt;&lt;</span> std<span class="hl opt">::</span>this_thread<span class="hl opt">::</span><span class="hl kwd">get_id</span><span class="hl opt">() &lt;&lt;</span> <span class="hl str">&quot;] Exception: &quot;</span> <span class="hl opt">&lt;&lt;</span> ex<span class="hl opt">.</span><span class="hl kwd">what</span><span class="hl opt">() &lt;&lt;</span> std<span class="hl opt">::</span>endl<span class="hl opt">;</span>
<span class="hl lin">   99 </span>        global_stream_lock<span class="hl opt">.</span><span class="hl kwd">unlock</span><span class="hl opt">();</span>
<span class="hl lin">  100 </span>    <span class="hl opt">}</span>
<span class="hl lin">  101 </span>
<span class="hl lin">  102 </span>    std<span class="hl opt">::</span>cin<span class="hl opt">.</span><span class="hl kwd">get</span><span class="hl opt">();</span>
<span class="hl lin">  103 </span>
<span class="hl lin">  104 </span>    asio<span class="hl opt">::</span>error_code ec<span class="hl opt">;</span>
<span class="hl lin">  105 </span>    acceptor<span class="hl opt">-&gt;</span><span class="hl kwd">close</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">  106 </span>
<span class="hl lin">  107 </span>    sock<span class="hl opt">-&gt;</span><span class="hl kwd">shutdown</span><span class="hl opt">(</span>asio<span class="hl opt">::</span>ip<span class="hl opt">::</span>tcp<span class="hl opt">::</span>socket<span class="hl opt">::</span>shutdown_both<span class="hl opt">,</span> ec<span class="hl opt">);</span>
<span class="hl lin">  108 </span>    sock<span class="hl opt">-&gt;</span><span class="hl kwd">close</span><span class="hl opt">(</span>ec<span class="hl opt">);</span>
<span class="hl lin">  109 </span>
<span class="hl lin">  110 </span>    io_service<span class="hl opt">-&gt;</span><span class="hl kwd">stop</span><span class="hl opt">();</span>
<span class="hl lin">  111 </span>
<span class="hl lin">  112 </span>    <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> x <span class="hl opt">&lt;</span> <span class="hl num">2</span><span class="hl opt">; ++</span>x<span class="hl opt">)</span>
<span class="hl lin">  113 </span>    <span class="hl opt">{</span>
<span class="hl lin">  114 </span>        worker_threads<span class="hl opt">[</span>x<span class="hl opt">].</span><span class="hl kwd">join</span><span class="hl opt">();</span>
<span class="hl lin">  115 </span>    <span class="hl opt">}</span>
<span class="hl lin">  116 </span>
<span class="hl lin">  117 </span>    <span class="hl kwa">return</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl lin">  118 </span><span class="hl opt">}</span>
</pre>

<strong>Output</strong>
<pre class="hl"><span class="hl lin">    1 </span>[140323662600000] Press [return] to exit.
<span class="hl lin">    2 </span>[140323645835008] Thread Start
<span class="hl lin">    3 </span>[140323637442304] Thread Start
<span class="hl lin">    4 </span>Listening on: 127.0.0.1:7777
<span class="hl lin">    5 </span>
<span class="hl lin">    6 </span>[140323637442304] Thread Finish
<span class="hl lin">    7 </span>[140323645835008] Thread Finish
</pre>

This example looks pretty close to the previous. In fact, very little has changed! As mentioned before, this is one of the nice
things about the asio library. As we take the time to learn the different components, we began to be able to easily
understand the others because of the dependency of the components on each other. Once we run the program, we have a server running
on port 7777. We can run the command "telnet localhost 7777" to start a connection to the server and trigger the OnAccept function.
<br>
<br>
However, the server will not accept any more connections. This is because we only call async_accept once and only have one socket
object. We will address the design strategies for servers later, as we are only getting started with the core API needed right now.
At this time, we can also briefly mention the close and shutdown functions we have seen. In our examples, we have chosen to use the
error_code variable version to ensure no exceptions are thrown. This is because sometimes shutdown might not be valid on a socket
(if it was not connected or accepted) while close is. If we use exception handling, one of the functions might not get called as a
result. So we will simply try to call both functions for sockets and ignore the errors.
<br>
<br>
The basics of connecting and accepting have been covered now. We now know how to connect to a remote host as well as accept an
incoming connection. However, we have not yet covered reading and writing to sockets yet. That will be the next topic of our focus.
<br>
<hr>
<div class="nav">
<a accesskey="p" href="pg7.html"><img src="prev.png" alt="Prev"></a><a accesskey="u" href="pg1.html"><img src="up.png" alt="Up"></a><a accesskey="h" href="pg1.html"><img src="home.png" alt="Home"></a><a accesskey="n" href="pg9.html"><img src="next.png" alt="Next"></a>
</div>
</div>
</body>
</html>
